name: Update Data Files

on:
  push:
    paths:
      - "assets/data/*.csv"
      - ".github/workflows/update_geojson.yml"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Python dependencies
        run: |
          pip install pandas geojson

      ###############################################################
      # STEP 1 — Convert CSV → events.geojson
      ###############################################################
      - name: Build GeoJSON from CSV
        run: |
          python3 <<'EOF'
          import pandas as pd
          import json
          import sys

          try:
              df = pd.read_csv("assets/data/events_timeline.csv")
          except Exception as e:
              print("Errore nel caricamento CSV:", e)
              sys.exit(1)

          features = []
          for _, row in df.iterrows():
              lat = row.get("latitude")
              lon = row.get("longitude")
              if pd.isna(lat) or pd.isna(lon):
                  continue

              props = {
                  "title": row.get("title", ""),
                  "date": row.get("date", ""),
                  "type": row.get("type", ""),
                  "location": row.get("location", ""),
                  "source": row.get("source", ""),
                  "archived": row.get("archived", ""),
                  "verification": row.get("verification", ""),
                  "notes": row.get("notes", "")
              }

              features.append({
                  "type": "Feature",
                  "geometry": {
                      "type": "Point",
                      "coordinates": [float(lon), float(lat)]
                  },
                  "properties": props
              })

          data = {"type": "FeatureCollection", "features": features}

          with open("assets/data/events.geojson", "w", encoding="utf-8") as f:
              json.dump(data, f, ensure_ascii=False, indent=2)

          print("GeoJSON generato correttamente.")
          EOF

      ###############################################################
      # STEP 2 — Clean, normalize and enhance events.geojson
      ###############################################################
      - name: Normalize GeoJSON fields
        run: |
          python3 <<'EOF'
          import json
          import sys

          try:
              with open("assets/data/events.geojson", "r", encoding="utf-8") as f:
                  data = json.load(f)
          except Exception as e:
              print("Errore caricando GeoJSON:", e)
              sys.exit(1)

          changed = False

          for feature in data.get("features", []):
              props = feature.get("properties", {})

              # Rename source → link
              if "source" in props:
                  props["link"] = props.pop("source")
                  changed = True

              # Rename notes → description
              if "notes" in props:
                  props["description"] = props.pop("notes")
                  changed = True

              # Add intensity if missing
              if "intensity" not in props:
                  props["intensity"] = 0.7 if props.get("verification") == "verified" else 0.2
                  changed = True

              # Clean NaN
              for k, v in list(props.items()):
                  if v == "NaN" or str(v).lower() == "nan":
                      props[k] = None if k == "link" else ""
                      changed = True

          if changed:
              with open("assets/data/events.geojson", "w", encoding="utf-8") as f:
                  json.dump(data, f, ensure_ascii=False, indent=2)
              print("GeoJSON normalizzato.")
          else:
              print("GeoJSON già pulito. Nessuna modifica.")
          EOF

      ###############################################################
      # STEP 3 — Validate GeoJSON to ensure it is well formed
      ###############################################################
      - name: Validate GeoJSON
        run: |
          python3 <<'EOF'
          import geojson
          import sys

          try:
              with open("assets/data/events.geojson", "r", encoding="utf-8") as f:
                  obj = geojson.load(f)
          except Exception as e:
              print("Errore aprendo il file per la validazione:", e)
              sys.exit(1)

          if not geojson.is_valid(obj)["valid"]:
              print("GeoJSON non valido:", geojson.is_valid(obj))
              sys.exit(1)

          print("GeoJSON valido.")
          EOF

      ###############################################################
      # STEP 4 — Convert CSV → timeline JSON
      ###############################################################
      - name: Build timeline JSON
        run: |
          python3 <<'EOF'
          import pandas as pd
          import json
          import sys

          try:
              df = pd.read_csv("assets/data/events_timeline.csv")
          except Exception as e:
              print("Errore caricando CSV timeline:", e)
              sys.exit(1)

          events = []
          for _, row in df.iterrows():
              events.append({
                  "title": row.get("title", ""),
                  "date": row.get("date", ""),
                  "type": row.get("type", ""),
                  "location": row.get("location", ""),
                  "latitude": row.get("latitude", None),
                  "longitude": row.get("longitude", None),
                  "verification": row.get("verification", ""),
                  "archived": row.get("archived", ""),
                  "notes": row.get("notes", "")
              })

          out = {"events": events}

          with open("assets/data/events_timeline.json", "w", encoding="utf-8") as f:
              json.dump(out, f, ensure_ascii=False, indent=2)

          print("Timeline JSON generato correttamente.")
          EOF

      ###############################################################
      # STEP 5 — Commit changes only if files changed
      ###############################################################
      - name: Commit and push updates
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          if git diff --quiet; then
            echo "Nessuna modifica da commitare."
          else
            git add assets/data/events.geojson
            git add assets/data/events_timeline.json
            git commit -m "Auto update data files"
            git push
          fi
