name: Update Data Files

on:
  push:
    paths:
      - "assets/data/*.csv"
      - ".github/workflows/update_geojson.yml"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Python dependencies
        run: pip install pandas numpy

      ###############################################################
      # STEP 1 — Convert CSV → events.geojson (CLEAN & ROBUST)
      ###############################################################
      - name: Generate Clean GeoJSON
        run: |
          python3 <<'EOF'
          import pandas as pd
          import json
          import sys
          import numpy as np

          try:
              # Legge il CSV
              df = pd.read_csv("assets/data/events_timeline.csv")
              
              # FIX CRITICO: Sostituisce NaN (float) con None (null) o stringhe vuote
              # Questo impedisce la creazione di "NaN" invalidi nel JSON
              df = df.replace({np.nan: None})
          except Exception as e:
              print("Errore nel caricamento CSV:", e)
              sys.exit(1)

          features = []
          for _, row in df.iterrows():
              lat = row.get("latitude")
              lon = row.get("longitude")
              
              # Salta se mancano le coordinate
              if lat is None or lon is None:
                  continue

              # Calcola intensity automaticamente
              verification = row.get("verification", "not verified")
              intensity = 0.7 if verification == "verified" else 0.2

              # Mappa le proprietà
              # Usa 'or ""' per assicurarsi che siano stringhe se None
              props = {
                  "title": row.get("title") or "Evento",
                  "date": row.get("date") or "",
                  "type": row.get("type") or "Drones",
                  "location": row.get("location") or "",
                  "source": row.get("source") or "",
                  "archived": row.get("archived") or "",
                  "verification": verification,
                  "notes": row.get("notes") or "",
                  "intensity": intensity
              }

              features.append({
                  "type": "Feature",
                  "geometry": {
                      "type": "Point",
                      "coordinates": [float(lon), float(lat)]
                  },
                  "properties": props
              })

          data = {"type": "FeatureCollection", "features": features}

          with open("assets/data/events.geojson", "w", encoding="utf-8") as f:
              json.dump(data, f, ensure_ascii=False, indent=2)

          print(f"✅ GeoJSON generato con {len(features)} eventi.")
          EOF

      ###############################################################
      # STEP 2 — Convert CSV → timeline JSON (CLEAN)
      ###############################################################
      - name: Generate Clean Timeline JSON
        run: |
          python3 <<'EOF'
          import pandas as pd
          import json
          import sys
          import numpy as np

          try:
              df = pd.read_csv("assets/data/events_timeline.csv")
              df = df.replace({np.nan: None})
          except Exception as e:
              print("Errore CSV Timeline:", e)
              sys.exit(1)

          events = []
          for _, row in df.iterrows():
              # Costruisce la descrizione HTML
              text_parts = []
              if row.get("location"): text_parts.append(f"Luogo: {row['location']}")
              if row.get("source"): text_parts.append(f"<br>Fonte: <a href='{row['source']}' target='_blank'>link</a>")
              if row.get("verification"): text_parts.append(f"<br>Verifica: {row['verification']}")
              
              description = "".join(text_parts)

              # Normalizza data (DD/MM/YY -> YYYY, MM, DD)
              try:
                  d_str = row.get("date", "")
                  day, month, year = d_str.split('/')
                  if len(year) == 2: year = "20" + year
              except:
                  continue # Salta date non valide

              events.append({
                  "start_date": {
                      "year": int(year),
                      "month": int(month),
                      "day": int(day)
                  },
                  "text": {
                      "headline": row.get("title") or "Evento",
                      "text": description
                  },
                  "location": {
                      "lat": row.get("latitude"),
                      "lon": row.get("longitude")
                  }
              })

          out = {"events": events}

          with open("assets/data/events_timeline.json", "w", encoding="utf-8") as f:
              json.dump(out, f, ensure_ascii=False, indent=2)

          print(f"✅ Timeline JSON generato con {len(events)} eventi.")
          EOF

      ###############################################################
      # STEP 3 — Commit changes
      ###############################################################
      - name: Commit and push updates
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add assets/data/events.geojson assets/data/events_timeline.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "Auto update: Clean JSON data" && git push)
