name: Aggiorna GeoJSON dal Google Sheet

on:
  schedule:
    - cron: "0 4 * * *"   # ogni giorno alle 04:00
  workflow_dispatch:      # per avviarlo a mano

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Installa Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Installa dipendenze
        run: pip install pandas requests

      - name: Scarica Google Sheet e converti in GeoJSON
        run: |
          python3 << 'EOF'
          import pandas as pd
          import requests
          import json

          # LINK GOOGLE SHEET 
          sheet_url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTUlBQ2E_vI60fmFoQ9eqstN_XBUhaMjOAK0j9OZLDyRxoXnOepmjHMKNkIrYGOekD51myxWg7USH7M/pub?gid=0&single=true&output=csv"

          # Converti in CSV esportato da Google
          csv_export = sheet_url.replace("/edit?usp=sharing", "/export?format=csv")

          df = pd.read_csv(csv_export)

          features = []
          for _, row in df.iterrows():
              feat = {
                  "type": "Feature",
                  "properties": {
                      "title": row["title"],
                      "date": row["date"],
                      "type": row["type"],
                      "location": row["location"],
                      "source": row["source"],
                      "notes": row.get("notes", "")
                  },
                  "geometry": {
                      "type": "Point",
                      "coordinates": [float(row["longitude"]), float(row["latitude"])]
                  }
              }
              features.append(feat)

          geojson = {
              "type": "FeatureCollection",
              "features": features
          }

          with open("events.geojson", "w", encoding="utf-8") as f:
              json.dump(geojson, f, ensure_ascii=False, indent=2)

          EOF

      - name: Commit & Push del nuovo GeoJSON
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git add events.geojson
          git commit -m "Aggiornato GeoJSON automatico"
          git push
        continue-on-error: true
