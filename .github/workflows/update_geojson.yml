name: Update Data Files

on:
  push:
    paths:
      - "assets/data/*.csv"
      - ".github/workflows/update_geojson.yml"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Python dependencies
        run: |
          pip install pandas

      ###############################################################
      # STEP 1 — Convert CSV → events.geojson
      ###############################################################
      - name: Build GeoJSON from CSV
        run: |
          python3 <<'EOF'
          import pandas as pd
          import json
          import sys

          try:
              df = pd.read_csv("assets/data/events_timeline.csv")
          except Exception as e:
              print("Errore nel caricamento CSV:", e)
              sys.exit(1)

          features = []
          for _, row in df.iterrows():
              lat = row.get("latitude")
              lon = row.get("longitude")
              if pd.isna(lat) or pd.isna(lon):
                  continue

              props = {
                  "title": row.get("title", ""),
                  "date": row.get("date", ""),
                  "type": row.get("type", ""),
                  "location": row.get("location", ""),
                  "source": row.get("source", ""),
                  "archived": row.get("archived", ""),
                  "verification": row.get("verification", ""),
                  "notes": row.get("notes", "")
              }

              features.append({
                  "type": "Feature",
                  "geometry": {
                      "type": "Point",
                      "coordinates": [float(lon), float(lat)]
                  },
                  "properties": props
              })

          data = {"type": "FeatureCollection", "features": features}

          with open("assets/data/events.geojson", "w", encoding="utf-8") as f:
              json.dump(data, f, ensure_ascii=False, indent=2)

          print("GeoJSON generato correttamente.")
          EOF

      ###############################################################
      # STEP 2 — Clean, normalize and enhance events.geojson
      ###############################################################
      - name: Normalize GeoJSON fields
        run: |
          python3 <<'EOF'
          import json
          import sys

          try:
              with open("assets/data/events.geojson", "r", encoding="utf-8") as f:
                  data = json.load(f)
          except Exception as e:
              print("Errore caricando GeoJSON:", e)
              sys.exit(1)

          changed = False

          for feature in data.get("features", []):
              props = feature.get("properties", {})

              # Rename source → link
              if "source" in props:
                  props["link"] = props.pop("source")
                  changed = True

              # Rename notes → description
              if "notes" in props:
                  props["description"] = props.pop("notes")
                  changed = True

              # Add intensity if missing
              if "intensity" not in props:
                  props["intensity"] = 0.7 if props.get("verification") == "verified" else 0.2
                  changed = True

              # Clean NaN
              for k, v in list(props.items()):
                  if v == "NaN" or str(v).lower() == "nan":
                      props[k] = None if k == "link" else ""
                      changed = True

          if changed:
              with open("assets/data/events.geojson", "w", encoding="utf-8") as f:
                  json.dump(data, f, ensure_ascii=False, indent=2)
              print("GeoJSON normalizzato.")
          else:
              print("GeoJSON già pulito. Nessuna modifica.")
          EOF

      ###############################################################
      # STEP 3 — Validate GeoJSON (custom validator, no external deps)
      ###############################################################
      - name: Validate GeoJSON
        run: |
          python3 <<'EOF'
          import json
          import sys
          from numbers import Number

          def error(msg):
              print("VALIDATION ERROR:", msg)
              sys.exit(1)

          try:
              with open("assets/data/events.geojson", "r", encoding="utf-8") as f:
                  data = json.load(f)
          except Exception as e:
              error(f"Impossibile leggere assets/data/events.geojson: {e}")

          # Basic FeatureCollection check
          if not isinstance(data, dict):
              error("Root object non è un oggetto JSON.")
          if data.get("type") != "FeatureCollection":
              error(f"Root type non è FeatureCollection: {data.get('type')}")
          features = data.get("features")
          if not isinstance(features, list):
              error("features non è una lista.")

          # Check each feature
          for i, feat in enumerate(features):
              if not isinstance(feat, dict):
                  error(f"Feature {i} non è un oggetto.")
              if feat.get("type") != "Feature":
                  error(f"Feature {i} type non è 'Feature': {feat.get('type')}")
              geom = feat.get("geometry")
              if not isinstance(geom, dict):
                  error(f"Feature {i} geometry mancante o non è un oggetto.")
              gtype = geom.get("type")
              if gtype != "Point":
                  error(f"Feature {i} geometry type non è 'Point': {gtype}")
              coords = geom.get("coordinates")
              if not (isinstance(coords, list) and len(coords) == 2):
                  error(f"Feature {i} coordinates non valide: {coords}")
              lon, lat = coords
              if not (isinstance(lon, Number) and isinstance(lat, Number)):
                  error(f"Feature {i} coordinate non numeriche: {coords}")

              props = feat.get("properties")
              if not isinstance(props, dict):
                  error(f"Feature {i} properties non è un oggetto.")

          print("GeoJSON validazione minima: OK")
          EOF

      ###############################################################
      # STEP 4 — Convert CSV → timeline JSON
      ###############################################################
      - name: Build timeline JSON
        run: |
          python3 <<'EOF'
          import pandas as pd
          import json
          import sys

          try:
              df = pd.read_csv("assets/data/events_timeline.csv")
          except Exception as e:
              print("Errore caricando CSV timeline:", e)
              sys.exit(1)

          events = []
          for _, row in df.iterrows():
              events.append({
                  "title": row.get("title", ""),
                  "date": row.get("date", ""),
                  "type": row.get("type", ""),
                  "location": row.get("location", ""),
                  "latitude": row.get("latitude", None),
                  "longitude": row.get("longitude", None),
                  "verification": row.get("verification", ""),
                  "archived": row.get("archived", ""),
                  "notes": row.get("notes", "")
              })

          out = {"events": events}

          with open("assets/data/events_timeline.json", "w", encoding="utf-8") as f:
              json.dump(out, f, ensure_ascii=False, indent=2)

          print("Timeline JSON generato correttamente.")
          EOF

      ###############################################################
      # STEP 5 — Commit changes only if files changed
      ###############################################################
      - name: Commit and push updates
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          if git diff --quiet; then
            echo "Nessuna modifica da commitare."
          else
            git add assets/data/events.geojson
            git add assets/data/events_timeline.json
            git commit -m "Auto update data files"
            git push
          fi
