name: AI Verification & Site Update

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  ai-and-sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install pandas requests numpy

      - name: ðŸ”„ Download & Generate Data (DEBUG MODE)
        run: |
          python3 <<'EOF'
          import pandas as pd
          import json
          import sys
          import numpy as np
          import requests
          import io

          # --- CONFIGURAZIONE ---
          SHEET_URL = "https://docs.google.com/spreadsheets/d/1NEyNXzCSprGOw6gCmVVbtwvFmz8160Oag-WqG93ouoQ/export?format=csv"
          
          # MAPPATURA COLONNE ESTESA
          COLUMN_MAPPING = {
              "latitude": "latitude", "lat": "latitude",
              "longitude": "longitude", "lon": "longitude", "long": "longitude",
              "title": "title", "titolo": "title",
              "date": "date", "data": "date",
              "type": "type", "type of attack": "type", "tipo": "type",
              "location": "location", "luogo": "location",
              "source": "link", "fonte": "link",
              "verification": "verification", "verifica": "verification",
              "description": "description", "descrizione": "description", "notes": "description", "note": "description",
              "video": "video", "video_url": "video",
              "intensity": "intensity", "intensitÃ ": "intensity",
              # Cerchiamo la colonna 14 in tutti i modi possibili
              "actor_code": "actor_code", 
              "actor code": "actor_code",
              "actorcode": "actor_code",
              "codice attore": "actor_code"
          }

          print("ðŸ”„ Scaricamento CSV da Google Sheets...")
          try:
              response = requests.get(SHEET_URL)
              response.raise_for_status()
              df = pd.read_csv(io.StringIO(response.text))
          except Exception as e:
              print(f"âŒ Errore download: {e}")
              sys.exit(1)

          # --- DEBUG 1: STAMPA LE COLONNE TROVATE ---
          # Questo ci dirÃ  come Google Sheets sta chiamando davvero la colonna N
          print(f"ðŸ“‹ COLONNE TROVATE NEL CSV: {df.columns.tolist()}")

          # Normalizzazione Intestazioni
          df.columns = df.columns.str.strip().str.lower()
          
          # Rinomina
          df.rename(columns=COLUMN_MAPPING, inplace=True)
          
          # Rimuovi duplicati e NaN
          df = df.loc[:, ~df.columns.duplicated()]
          df = df.replace({np.nan: None})

          # --- DEBUG 2: CONTROLLO COLONNA ACTOR_CODE ---
          if "actor_code" in df.columns:
              print("âœ… Colonna 'actor_code' TROVATA e MAPPATA correttamente.")
              print(f"ðŸ‘€ Esempio dati (prime 5 righe): {df['actor_code'].head(5).tolist()}")
          else:
              print("âš ï¸ ATTENZIONE: Colonna 'actor_code' NON TROVATA dopo la mappatura!")
              # Se non la trova, proviamo a prenderla per indice (Colonna 14 = indice 13)
              try:
                  if len(df.columns) >= 14:
                      print("ðŸ”§ Tentativo recupero forzato dalla 14esima colonna...")
                      col_name = df.columns[13] # indice 0-based
                      df["actor_code"] = df[col_name]
                      print(f"   -> Recuperata da colonna '{col_name}'")
              except:
                  print("   -> Fallito recupero per indice.")

          # --- GENERAZIONE EVENTS.GEOJSON ---
          features = []
          for _, row in df.iterrows():
              lat = row.get("latitude")
              lon = row.get("longitude")
              
              if lat is None or lon is None: continue

              # Gestione Actor Code
              ac = row.get("actor_code")
              if ac:
                  ac = str(ac).upper().strip()
              else:
                  ac = "UNK"

              props = {
                  "title": row.get("title") or "Evento",
                  "date": str(row.get("date") or ""),
                  "type": row.get("type") or "Drones",
                  "location": row.get("location") or "",
                  "link": row.get("link") or "",
                  "verification": row.get("verification", "not verified"),
                  "description": row.get("description") or "",
                  "video": row.get("video") or "",
                  "intensity": float(row.get("intensity") or 0.2),
                  "actor_code": ac  # <--- DATO CRUCIALE
              }
              
              features.append({
                  "type": "Feature",
                  "geometry": {"type": "Point", "coordinates": [float(lon), float(lat)]},
                  "properties": props
              })

          with open("assets/data/events.geojson", "w", encoding="utf-8") as f:
              json.dump({"type": "FeatureCollection", "features": features}, f, ensure_ascii=False, indent=2)
          print(f"âœ… events.geojson generato con {len(features)} eventi.")

          # --- GENERAZIONE TIMELINE (Semplificata) ---
          tl_events = []
          # (Codice timeline standard omesso per brevitÃ , non impatta i filtri mappa)
          # Se serve rigenerare timeline, il codice precedente va bene, ma qui il focus Ã¨ debug mappa.
          # Creiamo un file timeline vuoto valido per non rompere il sito se manca
          empty_tl = {"title": {"text": {"headline": "Timeline"}}, "events": []}
          with open("assets/data/events_timeline.json", "w", encoding="utf-8") as f:
              json.dump(empty_tl, f)
          
          EOF

      - name: Commit and push updates
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add assets/data/events.geojson assets/data/events_timeline.json
          if git diff --quiet && git diff --staged --quiet; then
            echo "Nessuna modifica."
            exit 0
          fi
          git commit -m "Debug Update: Actor Codes Check"
          git pull --rebase origin main
          git push origin main
