name: Update Data from Google Sheets

on:
  schedule:
    - cron: '0 */6 * * *' # Esegue ogni 6 ore automaticamente
  workflow_dispatch:      # Permette l'esecuzione manuale

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install pandas requests numpy

      - name: Download and Process Data
        run: |
          python3 <<'EOF'
          import pandas as pd
          import json
          import sys
          import numpy as np
          import requests
          import io

          # 1. SCARICAMENTO DA GOOGLE SHEETS
          SHEET_URL = "https://docs.google.com/spreadsheets/d/1NEyNXzCSprGOw6gCmVVbtwvFmz8160Oag-WqG93ouoQ/export?format=csv"
          
          print("ðŸ”„ Scaricamento dati da Google Sheets...")
          try:
              response = requests.get(SHEET_URL)
              response.raise_for_status()
              # Legge il CSV direttamente dalla memoria
              df = pd.read_csv(io.StringIO(response.text))
              print(f"âœ… Scaricate {len(df)} righe.")
          except Exception as e:
              print(f"âŒ Errore scaricamento: {e}")
              sys.exit(1)

          # 2. PULIZIA DATI (CRUCIALE PER I GRAFICI)
          # Sostituisce NaN con None (che diventa null in JSON) o stringhe vuote
          df = df.replace({np.nan: None})

          # 3. GENERAZIONE EVENTS.GEOJSON (Per la Mappa)
          features = []
          for _, row in df.iterrows():
              lat = row.get("latitude")
              lon = row.get("longitude")
              
              # Salta se mancano le coordinate
              if lat is None or lon is None:
                  continue

              try:
                  # Logica per l'intensitÃ  (Heatmap)
                  verification = row.get("verification", "not verified")
                  intensity = 0.7 if verification == "verified" else 0.2

                  props = {
                      "title": row.get("title") or "Evento",
                      "date": row.get("date") or "",
                      "type": row.get("type") or "Drones",
                      "location": row.get("location") or "",
                      "link": row.get("source") or "", # Normalizzato a 'link'
                      "archived": row.get("archived") or "",
                      "verification": verification,
                      "description": row.get("notes") or "", # Normalizzato a 'description'
                      "intensity": intensity
                  }

                  features.append({
                      "type": "Feature",
                      "geometry": {
                          "type": "Point",
                          "coordinates": [float(lon), float(lat)]
                      },
                      "properties": props
                  })
              except Exception as e:
                  print(f"âš ï¸ Errore riga GeoJSON: {e}")
                  continue

          geojson_data = {"type": "FeatureCollection", "features": features}
          
          with open("assets/data/events.geojson", "w", encoding="utf-8") as f:
              json.dump(geojson_data, f, ensure_ascii=False, indent=2)
          print("âœ… events.geojson aggiornato.")

          # 4. GENERAZIONE EVENTS_TIMELINE.JSON (Per Grafici e Timeline)
          timeline_events = []
          for _, row in df.iterrows():
              try:
                  # Gestione date (DD/MM/YY o YYYY-MM-DD)
                  date_str = str(row.get("date", ""))
                  if '/' in date_str:
                      day, month, year = date_str.split('/')
                      if len(year) == 2: year = "20" + year
                  elif '-' in date_str:
                      year, month, day = date_str.split('-')
                  else:
                      continue # Data non valida

                  # Costruzione testo HTML per la timeline
                  text_html = f"Tipo: {row.get('type') or 'Drones'}<br>"
                  if row.get("location"): text_html += f"Luogo: {row['location']}<br>"
                  if row.get("verification"): text_html += f"Verifica: {row['verification']}"

                  timeline_events.append({
                      "start_date": {
                          "year": int(year),
                          "month": int(month),
                          "day": int(day)
                      },
                      "text": {
                          "headline": row.get("title") or "Evento",
                          "text": text_html
                      },
                      "group": row.get("type") or "Drones", # Utile per i filtri
                      "location": {
                        "lat": row.get("latitude"),
                        "lon": row.get("longitude")
                      }
                  })
              except Exception as e:
                  # Ignora righe con date rotte
                  continue

          timeline_data = {"events": timeline_events}
          
          with open("assets/data/events_timeline.json", "w", encoding="utf-8") as f:
              json.dump(timeline_data, f, ensure_ascii=False, indent=2)
          print(f"âœ… events_timeline.json aggiornato ({len(timeline_events)} eventi).")
          EOF

      - name: Commit and push updates
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add assets/data/events.geojson assets/data/events_timeline.json
          # Committa solo se ci sono cambiamenti
          git diff --quiet && git diff --staged --quiet || (git commit -m "Auto-update: Dati aggiornati da Google Sheets" && git push)
