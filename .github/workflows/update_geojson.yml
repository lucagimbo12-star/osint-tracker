name: Update Data Files

on:
  push:
    paths:
      - "assets/data/*.csv"
      - ".github/workflows/update_geojson.yml"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install required packages
        run: pip install pandas

      ###############################################################
      # STEP 1 — Convert CSV → GeoJSON (se lo usavi già)
      ###############################################################
      - name: Convert attacks CSV to GeoJSON
        run: |
          python3 <<EOF
          import pandas as pd
          import json

          df = pd.read_csv("assets/data/events_timeline.csv")

          features = []
          for _, row in df.iterrows():
              lat = row.get("latitude")
              lon = row.get("longitude")
              if pd.isna(lat) or pd.isna(lon):
                  continue

              features.append({
                  "type": "Feature",
                  "geometry": {
                      "type": "Point",
                      "coordinates": [float(lon), float(lat)]
                  },
                  "properties": {
                      "title": row.get("title", ""),
                      "date": row.get("date", ""),
                      "type": row.get("type", ""),
                      "location": row.get("location", ""),
                      "source": row.get("source", ""),
                      "archived": row.get("archived", ""),
                      "verification": row.get("verification", ""),
                      "notes": row.get("notes", "")
                  }
              })

          geojson = {"type": "FeatureCollection", "features": features}

          with open("assets/data/events.geojson", "w", encoding="utf-8") as f:
              json.dump(geojson, f, ensure_ascii=False, indent=2)
          EOF

      ###############################################################
      # STEP 2 — Convert CSV → timeline JSON
      ###############################################################
      - name: Convert CSV to Timeline JSON
        run: |
          python3 <<EOF
          import pandas as pd
          import json

          df = pd.read_csv("assets/data/events_timeline.csv")

          events = []
          for _, row in df.iterrows():
              events.append({
                  "title": row.get("title", ""),
                  "date": row.get("date", ""),
                  "type": row.get("type", ""),
                  "location": row.get("location", ""),
                  "latitude": row.get("latitude", None),
                  "longitude": row.get("longitude", None),
                  "source": row.get("source", ""),
                  "archived": row.get("archived", ""),
                  "verification": row.get("verification", ""),
                  "notes": row.get("notes", "")
              })

          out = {"events": events}

          with open("assets/data/events_timeline.json", "w", encoding="utf-8") as f:
              json.dump(out, f, ensure_ascii=False, indent=2)
          EOF

      ###############################################################
      # Commit changes back to repo
      ###############################################################
      - name: Commit and push updates
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add assets/data/events.geojson
          git add assets/data/events_timeline.json
          git commit -m "Updated data files" || echo "No changes to commit"
          git push
